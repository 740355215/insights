#!/usr/bin/env node

// Thanks to https://github.com/mysamai/mysam/blob/master/bin/mysam for this script!

var fs = require('fs')
var path = require('path')
var program = require('commander')
var root = path.join(__dirname, '..')
var pkg = require(path.join(root, 'package.json'))

program.version(pkg.version)
  .usage('<command> [options]')
  .description('Run insights server')
  .option('-p, --port [number]', 'Port for server. Defaults to 8000')
  .option('-h, --host [domain]', 'Host for server. Defaults to 127.0.0.1')
  .option('--data [folder]', 'Where to store the local NeDB database. Defaults to ~/.insights/data')
  .option('--secret [path]', 'Where to store the authentication secret. Defaults to ~/.insights/secret')
  .option('--public [folder]', 'HTML folder to server. Defaults to ../insights-web/build')

program.parse(process.argv)

process.env.NODE_ENV = program.develop ? 'development' : 'production'
process.env.NODE_CONFIG_DIR = path.join(__dirname, '..', '..', 'insights-api', 'config')

process.env.INSIGHTS_API_DATA = program.data || process.env.INSIGHTS_API_DATA || path.join(require('os').homedir(), '.insights', 'data')
process.env.INSIGHTS_PORT = program.port || process.env.INSIGHTS_PORT || 8000
process.env.INSIGHTS_HOST = program.host || process.env.INSIGHTS_HOST || '127.0.0.1'

const secretPath = program.secret || path.join(require('os').homedir(), '.insights', 'secret')

try {
  const secret = fs.readFileSync(secretPath, 'utf8').trim()
  if (secret.length < 64) {
    console.error(`Fatal Error! Read secret at ${secretPath} was less than 64 characters long!`)
    process.exit(1)
  }
  process.env.AUTHENTICATION_SECRET = secret
} catch (error) {
  console.error(`Fatal Error! Could not find authentication secret at ${secretPath}`)
  process.exit(1)
}


if (program.public) {
  process.env.INSIGHTS_WEB_BUILD = program.public
}

require('../app/start')
